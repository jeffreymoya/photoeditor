# TASK-0802 Blocking Report

**Date**: 2025-10-22
**Task**: TASK-0802 - Capture current mutation testing evidence
**Status**: BLOCKED
**Agent**: task-picker (claude-sonnet-4-5)
**Branch**: main

## Summary

Attempted to execute TASK-0802 (mutation testing evidence capture) but encountered blocking issues that prevent completion. The task infrastructure was successfully configured, but pre-existing test flakiness in the codebase prevents Stryker from completing its dry run, which is a prerequisite for mutation testing.

## Blocking Issues

### Issue 1: Pre-existing Test Flakiness
**Severity**: P0 - Blocks mutation testing entirely
**Location**: `backend/tests/unit/providers/seedream.provider.test.ts`
**Description**: 6 tests in the "editImage - Error Paths" suite consistently timeout during Stryker's initial dry run

**Affected Tests**:
- `should handle API error responses` - Timeout at 10s
- `should handle missing edited image URL in response` - Timeout at 10s
- `should handle network errors` - Timeout at 10s
- `should handle 500 server errors` - Timeout at 10s
- `should handle 401 unauthorized errors` - Timeout at 10s
- `should handle JSON parsing errors` - Timeout at 10s

**Root Cause Analysis**:
- Tests use Jest fake timers (`jest.useFakeTimers()`) configured in `backend/tests/setup.js`
- Seedream provider tests involve async operations with retry logic (via Cockatiel resilience policies)
- The combination of fake timers + async retry operations causes test execution to hang
- Tests pass when run normally via `pnpm test:unit` but fail during Stryker's instrumented dry run
- This suggests the instrumentation amplifies timing issues

**Impact**:
- Stryker requires all tests to pass in the dry run before mutation testing can begin
- Cannot generate mutation evidence until these tests are stable

### Issue 2: Monorepo Module Resolution (Resolved with Workaround)
**Severity**: P1 - Initially blocking, now worked around
**Description**: Stryker's default sandbox mode cannot resolve `@photoeditor/shared` module in monorepo context

**Attempted Solutions**:
1. ❌ `symlinkNodeModules: true` - Module still not found in sandbox
2. ❌ Custom jest config with remapped paths - Paths rewritten incorrectly in sandbox
3. ✅ `inPlace: true` mode - Works but mutates source files directly (with backup)

**Resolution**: Configured `inPlace: true` which eliminated module resolution issues but then revealed Issue 1 (test flakiness)

## Work Completed

### Configuration Files Created/Modified

1. **backend/stryker.conf.json**
   - Added `@stryker-mutator/jest-runner` plugin
   - Configured `inPlace: true` mode to avoid sandbox module resolution issues
   - Set mutation targets: `src/services/**/*.ts` and `src/providers/**/*.ts`
   - Excluded infrastructure code: lambdas, libs, domain, repositories, utils
   - Configured reporters: `html` and `json`
   - Set output paths:
     - HTML: `docs/evidence/mutation/index.html`
     - JSON: `docs/evidence/mutation/mutation-report.json`
   - Set threshold: `break: 60` (60% mutation score minimum)

2. **backend/jest.stryker.config.js** (new file)
   - Created specialized Jest config for mutation testing
   - Restricted test scope to unit tests for services, providers, and libs only
   - Excluded lambda, contract, and integration tests
   - Disabled coverage collection (Stryker handles this)
   - Simplified reporters for faster execution

3. **docs/evidence/mutation/** (directory created)
   - Created directory structure for mutation testing artifacts
   - Currently empty (awaiting successful mutation test run)

## Commands Executed

```bash
# Inspection phase
cat backend/stryker.conf.json
pnpm --filter @photoeditor/backend test:unit -- --coverage

# Multiple mutation test attempts (all blocked by test failures)
pnpm --filter @photoeditor/backend test:mutation

# Configuration variations tested:
# - Default sandbox mode with @photoeditor/shared module mapping
# - Sandbox mode with symlinkNodeModules: true
# - Custom jest config with absolute paths
# - InPlace mode (current, revealed test flakiness)
```

## Evidence

### Stryker Dry Run Output (Excerpt)
```
[INFO] Starting initial test run (jest test runner with "perTest" coverage analysis)
[ERROR] One or more tests failed in the initial test run:
  SeedreamProvider editImage - Error Paths should handle API error responses
    Error: thrown: "Exceeded timeout of 10000 ms for a test"
  [... 5 more similar timeouts ...]
[ERROR] Stryker: There were failed tests in the initial test run.
[INFO] Resetting your original files from .stryker-tmp/backup-OYxcKP.
```

### Test Execution Comparison
- **Normal execution**: `pnpm test:unit` ✅ All tests pass
- **Stryker dry run**: ❌ 6 tests timeout in seedream.provider.test.ts

## Next Steps

### Immediate Actions Required

1. **Create TASK-0803**: Fix seedream.provider.test.ts timer issues
   - Investigate fake timer + async retry interaction
   - Options to consider:
     - Use real timers for these specific tests
     - Mock the retry mechanism differently
     - Increase timeout for mutation testing context
     - Refactor tests to avoid timer dependency

2. **Re-run TASK-0802**: Once tests are stable
   - Execute `pnpm test:mutation`
   - Verify mutation score ≥60%
   - Generate HTML and JSON reports
   - Create dated mutation summary in `docs/tests/reports/`

### Alternative Approaches (if timer fix is complex)

1. **Exclude seedream tests from mutation testing temporarily**
   - Update `jest.stryker.config.js` to skip seedream tests
   - Document this as technical debt
   - Create follow-up task to include once stable

2. **Use command-line override**
   - Run Stryker with `--maxTestRunners 1` to reduce parallelism
   - May reduce timing-related failures

## Files Modified

```
backend/stryker.conf.json           # Configured for jest-runner, inPlace mode
backend/jest.stryker.config.js      # New: mutation-specific jest config
docs/evidence/mutation/             # New: empty directory awaiting artifacts
backend/CHANGELOG.md                # Updated with blocking status
tasks/backend/TASK-0802-*.yaml      # Status changed to 'blocked'
changelog/2025-10-22-task-0802-blocked.md  # This report
```

## Validation Status

❌ **Cannot validate** - Blocked by test failures

Expected validation commands (will run once unblocked):
```bash
pnpm --filter @photoeditor/backend lint -- --max-complexity=10
pnpm --filter @photoeditor/backend test:unit -- --coverage
pnpm --filter @photoeditor/backend test:mutation -- --threshold 60
ls docs/evidence/mutation
ls docs/tests/reports
```

## Standards Compliance

Configuration aligns with:
- `standards/backend-tier.md`: Services/Adapters require ≥60% mutation coverage
- `standards/testing-standards.md`: Mutation testing requirements for backend
- `standards/cross-cutting.md`: Quality attribute enforcement

## Recommendation

**Do not proceed with TASK-0802 until test stability is resolved.**

The blocking test flakiness is a legitimate finding that should be addressed before mutation testing. Stryker's dry run serves as a quality gate that has correctly identified unreliable tests that could produce false mutation survivors or false kills.

Create TASK-0803 as P1 priority to fix the timer issues, then resume TASK-0802.

## References

- Task file: `tasks/backend/TASK-0802-mutation-evidence.task.yaml`
- Stryker config: `backend/stryker.conf.json`
- Jest config: `backend/jest.stryker.config.js`
- Test setup: `backend/tests/setup.js`
- Flaky tests: `backend/tests/unit/providers/seedream.provider.test.ts`
- Standards: `standards/backend-tier.md`, `standards/testing-standards.md`
