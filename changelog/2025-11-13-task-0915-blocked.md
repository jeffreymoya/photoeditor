# TASK-0915 BLOCKED: Await CameraWithOverlay feature flags in tests

**Date**: 2025-11-13
**Task ID**: TASK-0915
**Status**: BLOCKED
**Area**: mobile
**Priority**: P1 (unblocker)

## Summary

Implementation completed successfully with all tests passing (566/566), but blocked by React 19 `act(...)` warnings that violate the hard acceptance criterion: "Jest output shows no `act(...)` or unhandled promise warnings from CameraWithOverlay tests."

## What Was Completed

### Implementation (task-implementer)
- ✅ Created deterministic feature flags mock (`mobile/src/utils/__mocks__/featureFlags.ts`)
- ✅ Updated 5 failing CameraWithOverlay test specs to use `waitFor` patterns
- ✅ Fixed Redux context loss via Redux-aware rerender helper
- ✅ All 566 mobile tests pass (previously 560/6)
- ✅ Lint/typecheck pass with zero new errors
- ✅ Coverage thresholds met (75.32% lines, 60.45% branches)

### Review (implementation-reviewer)
- ✅ Standards compliance verified
- ✅ Diff safety audit passed
- ✅ Code quality high (documented mocks, proper async patterns)
- ❌ **BLOCKER**: 13 React 19 act(...) warnings present

## Blocking Issue

**Root Cause**: The `CameraWithOverlay` component uses an async `useEffect` hook that calls `setFeatureFlags()` after awaiting `getDeviceCapability()`. React Test Renderer 19.0.0 emits warnings because this state update happens outside automatic `act()` wrapping.

**Code Location** (`mobile/src/features/camera/CameraWithOverlay.tsx:104-121`):
```typescript
useEffect(() => {
  const initFeatureFlags = async () => {
    const deviceCapability = await getDeviceCapability();
    const flags = shouldEnableFrameProcessors(userFrameProcessorEnabled, deviceCapability);
    setFeatureFlags(flags); // <- Triggers act warning
  };
  void initFeatureFlags();
}, [userFrameProcessorEnabled]);
```

**Why Tests Pass But Warnings Appear**:
- `waitFor` correctly waits for the Camera component to appear
- All assertions execute after state settles
- But the `setFeatureFlags` call isn't wrapped in `act()` by React Testing Library
- The warnings are `console.error` output, not test failures

## Comparison to TASK-0914 Precedent

**SettingsScreen** (TASK-0914) avoided this issue by:
- Rendering a "Loading device information..." message during async initialization
- Waiting for the loading state to **disappear** (observable UI change)
- By the time `waitFor` resolves, all state updates have completed

**CameraWithOverlay** differs:
- Returns `null` during initialization (no intermediate loading UI)
- Tests wait for Camera component to **appear** (happens after state update)
- The `setFeatureFlags` call occurs between render and `waitFor` assertion

## Remediation Options

### Option 1: Clarify Standards (Recommended)
- Open Standards CR to allow React 19 act warnings when tests pass
- Update acceptance criterion from "no act(...) warnings" to "no act(...) warnings **that cause test failures**"
- **Pros**: Fastest path, unblocks TASK-0911 pilot validation
- **Cons**: May mask real async issues in future

### Option 2: Component Refactor (Out of Scope)
- Change initialization to sync pattern (e.g., inject feature flags as prop)
- **Blocked**: Task constraint "Do not... runtime changes to CameraWithOverlay"
- Would require scope expansion and standards CR

### Option 3: Test Workaround (Anti-Pattern)
- Suppress console.error in jest setup
- **Blocked**: Violates `docs/agents/diff-safety-checklist.md` (requires Standards CR)

## Deferred Work

**DEFER-001**: Resolve React 19 act(...) warnings in CameraWithOverlay tests
- **Description**: 13 console.error warnings about unwrapped state updates
- **Root cause**: React Test Renderer 19.0.0 + async useEffect pattern
- **Blocking**: TASK-0915 validation
- **Priority**: P1 (unblocker for TASK-0911)
- **Remediation**: Standards CR to clarify warning acceptance policy

## Evidence

- Implementation summary: `.agent-output/task-implementer-summary-TASK-0915.md`
- Review summary: `.agent-output/implementation-reviewer-summary-TASK-0915.md`
- Test output with warnings: `.agent-output/implementation-reviewer-camera-test-TASK-0915.log`
- QA static: `.agent-output/implementation-reviewer-qa-static-TASK-0915.log`

## Next Steps

1. Decide on remediation option (Standards CR vs scope expansion)
2. If Standards CR: Update `standards/testing-standards.md` to clarify React 19 warning policy
3. If scope expansion: Update TASK-0915 to allow component refactor
4. Unblock TASK-0916 and TASK-0911 downstream work

## Impact

- **TASK-0916**: Blocked (depends on TASK-0915)
- **TASK-0911**: Pilot validation cannot proceed until camera tests stabilize
- **Mobile test suite**: Functional but noisy with 13 warnings per CameraWithOverlay test run
