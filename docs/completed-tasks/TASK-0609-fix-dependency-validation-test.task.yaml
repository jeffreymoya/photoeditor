schema_version: "1.0"
id: TASK-0609
title: Fix dependency validation test for @backend/core
status: completed
priority: P2
complexity: XS
area: backend

description: >-
  Dependency validation test fails because '@backend/core' is imported in bundled
  code but not declared in package.json dependencies. This appears to be a
  false positive - '@backend/core' is likely an internal import alias, not an
  external package. Update the test to handle internal aliases correctly.

outcome: >-
  Dependency validation test passes. Test correctly distinguishes between
  external package dependencies and internal import aliases/path mappings.

scope:
  in:
    - backend/tests/build/dependencies.test.js
    - backend/package.json (verification only)
    - backend/tsconfig.json (path mapping verification)
  out:
    - Actual dependencies (no package.json changes needed)
    - Source code imports
    - Weakening external package validation (must still catch real undeclared dependencies)
    - Modifying dependency-cruiser rules (layering enforcement is separate concern)
    - Changes that would allow AWS SDK imports in handlers (hard fail per global.md line 20)

context:
  issues: []
  related_docs:
    - docs/testing-standards.md
    - standards/backend-tier.md (Platform & Quality Layer, line 106-111)
    - standards/global.md (Org-wide guardrails, line 21)
  repo_paths:
    - backend/tests/build/dependencies.test.js:54
    - backend/tsconfig.json (paths configuration lines 24-28)
    - backend/package.json
  standards_references:
    - "backend-tier.md line 22: dependency-cruiser verifies layering"
    - "backend-tier.md line 106-111: Platform & Quality fitness gates"
    - "global.md line 21: depcruise + ts-prune + knip enforce architecture"
    - testing-standards.md: Build validation requirements

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
    - name: npm
      version: "10.x"
    - name: jest
      version: "29.x"

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
    - Maintain existing dependency validation logic
    - Add clear filtering for internal aliases
    - Document internal vs external package distinction
  standards_compliance:
    - "backend-tier.md line 22: dependency-cruiser must still verify handler \u2192 service \u2192 adapter layering"
    - "global.md line 21: depcruise rules enforce no cross-layer imports"
    - Test must distinguish internal aliases (@backend/*, @/*) from external packages
    - No weakening of external package validation (still catch undeclared npm dependencies)

plan:
  - id: 1
    title: Understand @backend/core imports
    details: >-
      Search for @backend/core imports in source code and verify it's defined
      in tsconfig.json paths as an internal alias.
    commands:
      - rg "@backend/core" backend/src
      - cat backend/tsconfig.json | grep -A 5 "paths"
    expected_files_touched: []

  - id: 2
    title: Update dependency validation test
    details: >-
      Modify dependencies.test.js to filter out internal path aliases when
      checking for undeclared dependencies. Add a list of known internal
      aliases (@backend/*, @/*) from tsconfig.json paths that should be
      excluded from external package validation. Ensure the test still catches
      real undeclared npm dependencies (e.g., if someone imports 'lodash'
      without declaring it).
    commands: []
    expected_files_touched:
      - backend/tests/build/dependencies.test.js

  - id: 3
    title: Run dependency validation test
    details: >-
      Verify the test now passes and correctly validates external dependencies
      while ignoring internal aliases.
    commands:
      - npm test --prefix backend -- dependencies.test.js
    expected_files_touched: []

acceptance_criteria:
  # Build Validation (testing-standards.md, backend-tier.md line 106-111)
  - Dependency validation test passes without false positives
  - Test correctly identifies and filters internal aliases (@backend/*, @/*)
  - Test still catches real undeclared npm dependencies (validation not weakened)
  - Test logic is documented with inline comments explaining internal vs external distinction

  # Standards Compliance (global.md line 21, backend-tier.md line 22)
  - dependency-cruiser rules still enforce handler → service → adapter layering (separate check)
  - Test does not interfere with depcruise cycle detection or cross-layer import prevention
  - Internal alias filtering is based on tsconfig.json paths configuration

  # Quality Gates (backend-tier.md line 111)
  - Test remains part of QA suite Stage E (Build Verification)
  - No false positives for internal imports (@backend/core, @/* patterns)

validation:
  commands:
    # Dependency validation test (fixed to handle internal aliases)
    - npm test --prefix backend -- dependencies.test.js

    # Verify layering and architecture rules still enforced (backend-tier.md line 22)
    - npm run lint:deps --prefix backend || echo "depcruise check for layering"

    # Ensure test is part of QA suite (testing-standards.md QA-E: Build Verification)
    - grep -q "dependencies.test.js" backend/package.json || npm test --prefix backend -- dependencies

  manual_checks:
    - Verify @backend/core and @/* are defined in tsconfig.json paths (lines 24-28)
    - Confirm test still catches a real undeclared dependency (e.g., temporarily add 'import lodash' without package.json entry)
    - Check that dependency-cruiser rules remain intact and separate from this test

deliverables:
  - path: backend/tests/build/dependencies.test.js
    description: Updated test with internal alias filtering logic

risks:
  - description: Test may miss real undeclared dependencies if filtering is too broad
    mitigation: Maintain external dependency validation; only filter known internal aliases defined in tsconfig.json paths (@backend/*, @/*). Add test comment documenting the filter list.
    impact: medium
    likelihood: low

  - description: Changes might accidentally weaken dependency validation
    mitigation: Manual verification step to test that real undeclared dependencies (e.g., lodash without package.json entry) are still caught
    impact: high
    likelihood: low

  - description: Internal alias list may become stale as tsconfig.json evolves
    mitigation: Document that the test's internal alias list must be synchronized with tsconfig.json paths. Consider reading tsconfig.json dynamically in future enhancement.
    impact: low
    likelihood: medium
