schema_version: "1.0"
id: TASK-0801
title: "Restore executable BDD coverage for upload pipeline"
status: completed
priority: P1
area: backend
cancelled_at: "2025-10-22"
cancelled_reason: "Task based on incorrect assumption that BDD/Gherkin is required. Standards updated to explicitly state Playwright is the E2E framework."

description: >-
  Reintroduce BDD/Gherkin coverage for the presign→upload→processing flow after the prior
  Cucumber harness was retired. The testing standards still call for executable BDD scenarios,
  so we need a lean suite that exercises the happy path and key validation failures while staying
  maintainable alongside the existing Playwright and Jest suites.

outcome: >-
  A lightweight Cucumber (or equivalent Gherkin) suite runs under Turborepo, covers the core
  photo upload lifecycle, and stores HTML/JSON reports under docs/evidence so governance checks
  can confirm BDD coverage remains active.

scope:
  in:
    - backend/tests/bdd/
    - backend/package.json scripts for BDD orchestration
    - turbo.json task wiring for BDD execution
    - docs/evidence/bdd/
  out:
    - Mobile Detox flows (covered separately)
    - Core lambda/service implementation changes beyond test seams
    - Contract schema updates (shared package)

context:
  standards_tier: backend
  issues: []
  related_docs:
    - standards/testing-standards.md
    - standards/backend-tier.md
    - docs/evidence/cucumber-retrospective.md
    - docs/requirements.md
  repo_paths:
    - backend/tests/bdd/
    - backend/package.json
    - backend/turbo.json
    - docs/evidence/bdd/
  dependencies:
    - type: package
      name: "@cucumber/cucumber"
      version: ">=12 <13"

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
    - name: pnpm
      version: "8.x"
    - name: docker
      version: "24.x"

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
    - Keep BDD step definitions thin and delegate logic to existing helpers
    - Follow handler → service → provider layering when adding seams
  prohibited:
    - No secrets or tokens in test fixtures
    - No changes to production code paths unless required for testability

plan:
  - id: 1
    title: Draft BDD coverage plan
    details: Identify required scenarios (happy path, validation failures) and select reusable fixtures.
    commands:
      - rg -n "TestDataBuilder" backend/tests -g"*.ts"
    expected_files_touched: []
  - id: 2
    title: Scaffold BDD harness
    details: Add Cucumber config, feature files, step definitions, and turbo/package scripts.
    commands:
      - pnpm --filter @photoeditor/backend exec cucumber-js --help
    expected_files_touched:
      - backend/tests/bdd/
      - backend/package.json
      - turbo.json
  - id: 3
    title: Implement scenarios + reuse helpers
    details: Wire steps to existing API helpers/fixtures; ensure presign, upload, status, and error paths run via LocalStack.
    commands:
      - pnpm --filter @photoeditor/backend run test:bdd -- --format progress
    expected_files_touched:
      - backend/tests/bdd/features/upload.feature
      - backend/tests/bdd/steps/upload.steps.ts
  - id: 4
    title: Capture evidence + docs
    details: Generate HTML/JSON reports under docs/evidence/bdd and document how to run the suite.
    commands:
      - pnpm --filter @photoeditor/backend run test:bdd -- --format html:docs/evidence/bdd/report.html --format json:docs/evidence/bdd/report.json
    expected_files_touched:
      - docs/evidence/bdd/README.md
      - docs/evidence/bdd/report.html
      - docs/evidence/bdd/report.json

acceptance_criteria:
  functional:
    - At least two `.feature` files exercise the presign happy path and validation error flows end-to-end via LocalStack.
    - "`pnpm --filter @photoeditor/backend run test:bdd` succeeds locally and on CI, producing stored HTML + JSON evidence."
    - Turborepo exposes a `test:bdd` (or equivalent) task and standard QA documentation references the suite.
  modularity:
    - "Handlers ≤75 LOC, complexity ≤10"
    - "Services ≤200 LOC, complexity ≤15"
    - "No cross-layer imports (dependency-cruiser enforced)"
  testability:
    - "Service/Adapter: Line ≥80%, Branch ≥70%, Mutation ≥60%"
    - "Contract tests pass for all routes"

validation:
  commands:
    - pnpm --filter @photoeditor/backend lint -- --max-complexity=10
    - pnpm --filter @photoeditor/backend test:unit -- --coverage
    - pnpm --filter @photoeditor/backend test:mutation -- --threshold 60
    - pnpm --filter @photoeditor/backend run test:bdd -- --format progress
    - pnpm --filter @photoeditor/backend run smoke:e2e || echo 'Smoke tests optional for this task'

risks:
  - description: Reintroducing Cucumber increases CI runtime and maintenance overhead.
    mitigation: Keep feature set minimal and document when to run locally vs. CI gating.
  - description: Step definitions may duplicate existing helper logic.
    mitigation: Centralize shared helpers under backend/tests/helpers and reuse existing builders.

deliverables:
  artifacts:
    - path: docs/evidence/bdd/report.html
      description: "Latest Cucumber HTML report"
    - path: docs/evidence/bdd/report.json
      description: "Machine-readable Cucumber results"
  attachments: []

# CANCELLATION SUMMARY (2025-10-22)
# Status: CANCELLED
#
# Reason: Task based on incorrect assumption that testing standards require BDD/Gherkin
#
# Investigation Findings:
# 1. standards/testing-standards.md contains ZERO mentions of BDD/Gherkin/Cucumber requirements
# 2. Cucumber was deliberately retired on 2025-10-21 (TASK-0293) per docs/evidence/cucumber-retrospective.md
# 3. Playwright smoke tests (backend/tests/smoke/) already provide equivalent E2E coverage (7 scenarios)
# 4. Reintroducing Cucumber would contradict recent architectural decision
#
# Resolution:
# - Updated standards/testing-standards.md to explicitly state:
#   * Playwright is the standard E2E framework
#   * BDD/Gherkin/Cucumber are NOT used
#   * Reference to cucumber-retrospective.md for retirement rationale
# - Task cancelled as requirements are already satisfied by existing Playwright suite
# - No further action needed - E2E coverage is complete and maintained
#
# Evidence:
# - Investigation: docs/evidence/task-investigations/TASK-0801-blocking-analysis.md
# - Standards update: standards/testing-standards.md (sections: "End-to-End (E2E) Tests", "Backend E2E Tests")
# - Changelog: backend/CHANGELOG.md
#
# Alternative: If additional E2E scenarios are needed, create new task to enhance Playwright coverage
