# Task: Implement feature flags and frame budget guardrails

schema_version: "1.1"
id: TASK-0911E
title: "Implement feature flags and frame budget guardrails (Android pilot)"
status: completed
blocked_reason:
priority: P2
area: mobile
unblocker: false
order: 5
blocked_by: [TASK-0911D]
depends_on: []
agent_completion_state: {}

clarifications:
  outstanding: []
  resolved: true
  evidence_path: "docs/evidence/tasks/TASK-0911-clarifications.md"

description: >-
  Implement feature flags and guardrails for VisionCamera Skia frame processors in
  Android pilot. Per user preferences: (1) User toggle in Settings to enable/disable
  overlays, (2) Frame budget telemetry to log >16ms violations, (3) Pilot-friendly
  defaults (enabled by default for pilot testers, easy toggle if issues). Use device
  allowlist seeded conservatively with modern Android devices (API 29+, 4GB+ RAM).
  iOS allowlist explicitly deferred to post-pilot phase per ADR-0011. Test on Android
  emulator to validate toggle and telemetry work correctly.

outcome: >-
  Feature flags implemented for Android pilot with user toggle in Settings, frame
  budget telemetry, and pilot-friendly defaults (enabled by default). Android device
  allowlist seeded conservatively with modern devices. Frame budget monitor logs
  >16ms violations with device model for telemetry. iOS support explicitly deferred.
  Tested on Android emulator with no UI thread starvation.

scope:
  in:
  - Android device allowlist for frame processor enablement (API 29+, 4GB+ RAM)
  - User toggle in Settings to enable/disable frame processors with performance 
    warning
  - Frame budget telemetry to log >16ms violations with device model
  - Pilot-friendly defaults (enabled by default for pilot, easy toggle if 
    issues)
  - Testing on Android emulator to validate toggle and telemetry
  - Documentation referencing ADR-0011 (Android-first) and ADR-0012 (Skia 
    integration)
  out:
  - iOS device allowlist (deferred to iOS pilot phase per ADR-0011)
  - Server-side feature flag control (not required for pilot)
  - Upload metrics measurement (deferred to TASK-0911F)
  - Memory profiling (completed in TASK-0911D)

context:
  affected_packages: [mobile]
  standards_tier: mobile
  related_docs:
  - standards/global.md
  - standards/AGENTS.md
  - standards/frontend-tier.md
  - standards/typescript.md
  - standards/testing-standards.md
  - adr/0011-android-first-pilot-strategy.md
  - adr/0012-visioncamera-skia-integration.md
  - docs/mobile/visioncamera-background-task-pilot.md
  repo_paths:
  - mobile/src/utils/featureFlags.ts
  - mobile/src/features/camera/frameBudgetMonitor.ts
  - mobile/src/features/camera/CameraWithOverlay.tsx
  - mobile/src/screens/SettingsScreen.tsx
  dependencies: []

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
  - name: pnpm
    version: "8.x"
  data: []

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
  - Implement feature flags per standards/frontend-tier.md state management 
    patterns
  - Monitor frame processing times with diagnostics to prevent UI jank
  - Use pilot-friendly defaults (frame processors enabled by default for Android
    pilot)
  - Android device allowlist seeded conservatively (API 29+, 4GB+ RAM)
  - Document iOS deferral per ADR-0011 Android-first strategy
  prohibited:
  - Do not implement iOS device allowlist (deferred to iOS pilot phase)
  - Do not implement server-side feature flag control (not required for pilot)
  - Do not implement upload metrics measurement (deferred to TASK-0911F)

plan:
- id: 1
  title: Create feature flag module
  details: >-
    Create mobile/src/utils/featureFlags.ts module with device allowlist and user
    toggle logic. Follow standards/frontend-tier.md#state--logic-layer for feature
    flag patterns. Use platform APIs (Platform.constants, DeviceInfo) to detect
    device model. Integrate with app settings state (Redux or AsyncStorage).
  actor: agent
  inputs:
  - standards/frontend-tier.md
  - React Native Platform API documentation
  outputs:
  - mobile/src/utils/featureFlags.ts
  definition_of_done:
  - Feature flag module created with device allowlist and user toggle
  - Module follows standards/frontend-tier.md state management patterns
  estimate: M
  expected_files_touched:
  - mobile/src/utils/featureFlags.ts
- id: 2
  title: Seed Android device allowlist with conservative defaults
  details: >-
    Seed Android device allowlist conservatively with modern devices (API 29+, 4GB+
    RAM).
    Include common pilot devices (e.g., Pixel 4+, Samsung Galaxy S10+). Document allowlist
    criteria in comments. Note iOS allowlist explicitly deferred per ADR-0011. Configure
    pilot-friendly defaults (frame processors enabled by default for devices on allowlist).
    Reference ADR-0011 and ADR-0012 in code comments per standards/typescript.md#analyzability.
  actor: agent
  inputs:
  - VisionCamera performance documentation
  - mobile/src/utils/featureFlags.ts
  - adr/0011-android-first-pilot-strategy.md
  outputs:
  - mobile/src/utils/featureFlags.ts (Android allowlist seeded)
  definition_of_done:
  - Android device allowlist seeded conservatively (API 29+, 4GB+ RAM)
  - Pilot-friendly defaults configured (enabled by default for allowlist 
    devices)
  - iOS deferral documented in comments with ADR-0011 reference
  - Allowlist criteria documented in comments
  estimate: S
  expected_files_touched:
  - mobile/src/utils/featureFlags.ts
- id: 3
  title: Create frame budget monitor module
  details: >-
    Create mobile/src/features/camera/frameBudgetMonitor.ts module to monitor frame
    processing times. Measure time delta for each frame processor execution. Log
    violations (>16ms) with device model and frame processor type. Emit telemetry
    to identify additional devices for allowlist. Follow standards/typescript.md#analyzability
    for structured logging with correlation IDs.
  actor: agent
  inputs:
  - standards/typescript.md
  - Reanimated worklet timing APIs
  outputs:
  - mobile/src/features/camera/frameBudgetMonitor.ts
  definition_of_done:
  - Frame budget monitor measures processing times per frame
  - Violations (>16ms) logged with device model and frame processor type
  - Telemetry emitted for allowlist expansion
  estimate: M
  expected_files_touched:
  - mobile/src/features/camera/frameBudgetMonitor.ts
- id: 4
  title: Integrate feature flags with CameraWithOverlay
  details: >-
    Update mobile/src/features/camera/CameraWithOverlay.tsx to check feature flags
    before enabling frame processors. Disable frame processors if device not on
    allowlist AND user has not manually enabled. Integrate frame budget monitor to
    track processing times. Log feature flag state (enabled/disabled) on component
    mount.
  actor: agent
  inputs:
  - mobile/src/utils/featureFlags.ts
  - mobile/src/features/camera/frameBudgetMonitor.ts
  - mobile/src/features/camera/CameraWithOverlay.tsx
  outputs:
  - mobile/src/features/camera/CameraWithOverlay.tsx (feature flag integration)
  definition_of_done:
  - CameraWithOverlay checks feature flags before enabling frame processors
  - Frame processors disabled if not on allowlist AND user has not enabled
  - Frame budget monitor integrated to track processing times
  estimate: M
  expected_files_touched:
  - mobile/src/features/camera/CameraWithOverlay.tsx
- id: 5
  title: Add user toggle in Settings screen
  details: >-
    Add user toggle in mobile/src/screens/SettingsScreen.tsx to enable/disable frame
    processors. Display performance warning when enabling on devices not on allowlist.
    Persist toggle state in AsyncStorage or Redux. Follow standards/frontend-tier.md#ui-components-layer
    for component patterns.
  actor: agent
  inputs:
  - mobile/src/screens/SettingsScreen.tsx
  - mobile/src/utils/featureFlags.ts
  - standards/frontend-tier.md
  outputs:
  - mobile/src/screens/SettingsScreen.tsx (user toggle)
  definition_of_done:
  - User toggle added to Settings screen
  - Performance warning displayed for devices not on allowlist
  - Toggle state persisted in AsyncStorage or Redux
  estimate: M
  expected_files_touched:
  - mobile/src/screens/SettingsScreen.tsx
- id: 6
  title: Add tests for feature flags and frame budget monitor
  details: >-
    Create tests for mobile/src/utils/featureFlags.ts and mobile/src/features/camera/frameBudgetMonitor.ts.
    Test device allowlist logic, user toggle integration, and frame budget violation
    detection. Follow standards/testing-standards.md coverage expectations (≥70%
    lines, ≥60% branches).
  actor: agent
  inputs:
  - mobile/src/utils/featureFlags.ts
  - mobile/src/features/camera/frameBudgetMonitor.ts
  - standards/testing-standards.md
  outputs:
  - mobile/src/utils/__tests__/featureFlags.test.ts
  - mobile/src/features/camera/__tests__/frameBudgetMonitor.test.ts
  definition_of_done:
  - Tests cover allowlist logic, user toggle, and budget violations
  - Tests meet standards/testing-standards.md coverage thresholds
  estimate: M
  expected_files_touched:
  - mobile/src/utils/__tests__/featureFlags.test.ts
  - mobile/src/features/camera/__tests__/frameBudgetMonitor.test.ts

validation:
  pipeline:
  - command: pnpm turbo run lint:fix --filter=photoeditor-mobile
    description: Auto-fix linting issues in mobile package
  - command: pnpm turbo run qa:static --filter=photoeditor-mobile
    description: Run static analysis (typecheck + lint) on mobile
  - command: pnpm turbo run test --filter=photoeditor-mobile
    description: Run unit tests for mobile package
  - command: pnpm turbo run test:coverage --filter=photoeditor-mobile
    description: Run tests with coverage reporting to verify thresholds (≥70% 
      lines, ≥60% branches per standards/testing-standards.md)
  manual_checks:
  - Test pilot-friendly defaults (frame processors enabled by default on Android
    emulator)
  - Test user toggle disables frame processors when user opts out
  - Test performance warning displayed when user enables on non-allowlist device
  - Test frame budget monitor logs violations (>16ms) with device model
  - Verify no UI thread starvation on Android emulator with feature flags
  - Verify Settings toggle state persists across app restarts

acceptance_criteria:
  must:
  - Android device allowlist implemented and seeded conservatively (API 29+, 
    4GB+ RAM)
  - Pilot-friendly defaults configured (frame processors enabled by default for 
    pilot)
  - User toggle in Settings disables frame processors when user opts out
  - Performance warning displayed when enabling on non-allowlist devices
  - Frame budget monitor logs >16ms violations with device model for telemetry
  - Feature flags integrated with CameraWithOverlay component
  - iOS allowlist explicitly deferred with ADR-0011 reference in code
  - Tests meet standards/testing-standards.md coverage thresholds (≥70% lines, 
    ≥60% branches)
  - pnpm turbo run qa:static --filter=photoeditor-mobile passes
  - No UI thread starvation on Android emulator with feature flags
  quality_gates:
  - Pilot-friendly defaults: frame processors enabled by default for Android 
      pilot
  - User toggle provides easy opt-out if issues arise
  - Frame budget violations logged with device model for telemetry and allowlist
    expansion
  - Documentation references ADR-0011 (Android-first) and ADR-0012 (Skia 
    integration)

artifacts:
- path: mobile/src/utils/featureFlags.ts
  description: Feature flag module with device allowlist and user toggle
- path: mobile/src/features/camera/frameBudgetMonitor.ts
  description: Frame budget monitor for processing time diagnostics
- path: mobile/src/utils/__tests__/featureFlags.test.ts
  description: Tests for feature flags
- path: mobile/src/features/camera/__tests__/frameBudgetMonitor.test.ts
  description: Tests for frame budget monitor

deliverables:
- mobile/src/utils/featureFlags.ts
- mobile/src/features/camera/frameBudgetMonitor.ts
- mobile/src/features/camera/CameraWithOverlay.tsx (feature flag integration)
- mobile/src/screens/SettingsScreen.tsx (user toggle)
- mobile/src/utils/__tests__/featureFlags.test.ts
- mobile/src/features/camera/__tests__/frameBudgetMonitor.test.ts

risks:
- description: Android device allowlist may be incomplete and exclude capable 
    devices
  mitigation: Conservative initial list (API 29+, 4GB+ RAM) prevents performance
    issues; telemetry from frame budget monitor identifies additional devices 
    for expansion; pilot scope limits initial exposure
- description: Pilot-friendly defaults (enabled by default) may expose 
    performance issues on edge-case devices
  mitigation: User toggle provides easy opt-out; frame budget telemetry catches 
    violations; conservative allowlist criteria minimize risk
- description: Frame budget monitor may introduce overhead and affect 
    measurements
  mitigation: Minimize monitor overhead with lightweight timing APIs; monitor 
    can be disabled if overhead proves significant; pilot validates overhead 
    acceptable
- description: iOS device allowlist deferred may delay iOS pilot phase
  mitigation: Android-first strategy (ADR-0011) is deliberate; iOS allowlist can
    be added when iOS support needed; frame processors are platform-agnostic
