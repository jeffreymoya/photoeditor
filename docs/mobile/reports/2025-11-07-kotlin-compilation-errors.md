# Kotlin Compilation Errors Investigation — 2025-11-07

## Context
- Date: 2025-11-07
- Environment: Ubuntu 22.04, Expo SDK 51.0.39, Android SDK 34
- Gradle: 8.8
- Java: OpenJDK 21.0.8
- Build Command: `pnpm exec expo run:android`

## Summary
After successfully resolving TLS handshake failures and emulator display issues, the Android build now fails during Kotlin compilation because Gradle still generates `R` and `BuildConfig` under the legacy namespace `com.photoeditor` while our Kotlin sources (and Expo config) expect `com.photoeditor.app`, leaving the auto-generated classes unresolved in `MainActivity.kt` and `MainApplication.kt`.

## Symptoms

### Build Failure
```
FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':app:compileDebugKotlin'.
> A failure occurred while executing org.jetbrains.kotlin.compilerRunner.GradleCompilerRunnerWithWorkers$GradleKotlinCompilerWorkAction
   > Compilation error. See log for more details
```

### Specific Compilation Errors
From `/tmp/gradle-build-third.log` and `/tmp/gradle-build-full.log`:

```
e: file:///home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainActivity.kt:18:14 Unresolved reference: R
e: file:///home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainActivity.kt:35:11 Unresolved reference: BuildConfig
e: file:///home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainApplication.kt:31:60 Unresolved reference: BuildConfig
e: file:///home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainApplication.kt:33:52 Unresolved reference: BuildConfig
e: file:///home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainApplication.kt:34:51 Unresolved reference: BuildConfig
e: file:///home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainApplication.kt:44:9 Unresolved reference: BuildConfig
```

## Affected Files

### mobile/android/app/src/main/java/com/photoeditor/app/MainActivity.kt
Line 18: `setTheme(R.style.AppTheme);`
- Error: Unresolved reference to `R`
- The R class is auto-generated by Android and should contain resource references

Line 35: `BuildConfig.IS_NEW_ARCHITECTURE_ENABLED`
- Error: Unresolved reference to `BuildConfig`
- BuildConfig is auto-generated by Gradle and contains build-time constants

### mobile/android/app/src/main/java/com/photoeditor/app/MainApplication.kt
Multiple references to `BuildConfig` (lines 31, 33, 34, 44) all failing with unresolved reference errors.

## Root Cause Analysis

### Gradle BuildConfig Generation Status
Task execution shows:
```
> Task :app:generateDebugBuildConfig UP-TO-DATE
```

The task is marked as UP-TO-DATE, suggesting:
1. Gradle believes BuildConfig has already been generated
2. The cached version may be stale or corrupt
3. The output location may not match where Kotlin is looking

### R Class Generation Status
Resource processing tasks completed:
```
> Task :app:processDebugResources UP-TO-DATE
```

Similar to BuildConfig, R class generation appears to have run but the generated files aren't being found by the Kotlin compiler.

### Confirmed Cause — Namespace drift between Expo config and Gradle
- Expo config (`mobile/app.json`) now declares both the iOS `bundleIdentifier` and Android `package` as `com.photoeditor.app`, and the Kotlin sources live under `package com.photoeditor.app`.
- The generated Android project (`mobile/android/app/build.gradle`) still uses the previous namespace/applicationId `com.photoeditor`, so Gradle emits `BuildConfig` and `R` into `com.photoeditor.*`.
- When `:app:compileDebugKotlin` runs, it looks for `com.photoeditor.app.BuildConfig` and `com.photoeditor.app.R` (matching the Kotlin package) but those classes do not exist, producing the unresolved reference errors listed in the Symptoms section.

#### Evidence collected 2025-11-07
- `mobile/android/app/build.gradle` retains the legacy identifiers:

```bash
$ sed -n '112,118p' mobile/android/app/build.gradle
    namespace "com.photoeditor"
    defaultConfig {
        applicationId "com.photoeditor"
        minSdkVersion rootProject.ext.minSdkVersion
```

- Kotlin sources are under `com.photoeditor.app`:

```bash
$ head -n 1 mobile/android/app/src/main/java/com/photoeditor/app/MainActivity.kt
package com.photoeditor.app
```

- Expo config already migrated to `com.photoeditor.app`:

```bash
$ jq '.expo.ios.bundleIdentifier, .expo.android.package' mobile/app.json
"com.photoeditor.app"
"com.photoeditor.app"
```

- Build outputs confirm Gradle generates under `com/photoeditor` only:

```bash
$ find mobile/android/app/build/generated/source/buildConfig -name "BuildConfig.java"
mobile/android/app/build/generated/source/buildConfig/debug/com/photoeditor/BuildConfig.java

$ find mobile/android/app/build/generated/source/buildConfig -path '*com/photoeditor/app*'
# (no files returned)
```

#### Why it surfaced now
Renaming the Expo identifiers (documented in `mobile/app.json`) happened after the native `android/` folder was last re-generated. Because `android/app/build.gradle` still reflects the old `com.photoeditor` namespace, Gradle never re-created the generated sources under `com.photoeditor.app`, and the Kotlin compiler regression appeared immediately once TLS/emulator blockers were removed and the build progressed to `:app:compileDebugKotlin`.

## Previous Build Attempts

### Attempt 1: Build without install (`--no-install`)
- Result: BUILD FAILED in 5m 6s
- Same compilation errors

### Attempt 2: Build with cache bypass
- Cleared Gradle caches: `~/.gradle/caches/modules-2/` and `~/.gradle/caches/8.8/`
- Result: BUILD FAILED in 1m 29s
- Same compilation errors

### Attempt 3: Full build (with install)
- Result: BUILD FAILED in 16s
- 612 actionable tasks: 34 executed, 578 up-to-date
- Same compilation errors

## Successful Resolutions from Earlier Session

The following issues were successfully fixed as prerequisites to reaching this compilation stage:

### 1. TLS Handshake Failure (RESOLVED ✓)
**Problem**: Gradle could not download Maven dependencies due to TLS negotiation failure with Java 21
**Solution**: Added to `mobile/android/gradle.properties`:
```properties
# Fix TLS handshake failures with Maven Central (Java 21+ compatibility)
systemProp.https.protocols=TLSv1.2,TLSv1.3
```

### 2. Missing expo-camera Dependency (RESOLVED ✓)
**Problem**: `Could not find com.google.android:cameraview:1.0.0`
**Solution**: Added expo-camera local maven repository to `mobile/android/build.gradle`:
```gradle
maven {
    // Expo Camera local maven for cameraview:1.0.0
    url(new File(['node', '--print', "require.resolve('expo-camera/package.json')"].execute(null, rootDir).text.trim(), '../android/maven'))
}
```

### 3. Emulator Display Issues (RESOLVED ✓)
**Problem**: Emulator booted but showed blank gray/black screen
**Solution**:
- Wiped emulator data: `emulator -avd Pixel_API_34 -wipe-data`
- Launched with proper GPU and KVM flags: `-gpu swiftshader_indirect -qemu -enable-kvm`
- Updated Makefile with automated emulator launch script

## Current Build Environment Status

### Emulator Status: OPERATIONAL ✓
```bash
$ adb devices
List of devices attached
emulator-5554	device

$ adb shell getprop sys.boot_completed
1

$ adb shell dumpsys window | grep -A 2 "mCurrentFocus"
mCurrentFocus=Window{f4427b8 u0 com.google.android.apps.nexuslauncher/com.google.android.apps.nexuslauncher.NexusLauncherActivity}
```

Emulator is fully booted, UI rendering works, and home screen is displayed.

### Gradle Daemon Status: ACTIVE
Java processes show Gradle daemon at 91% CPU during compilation, Kotlin compiler at 214% CPU - build pipeline is active and healthy up until the compilation failure.

## Potential Causes — Status Update

### 1. Namespace Configuration Issue — ✅ Confirmed
Mismatch between `mobile/android/app/build.gradle` (`namespace/applicationId = "com.photoeditor"`) and Kotlin/Expo namespaces (`com.photoeditor.app`) directly explains the missing `R` and `BuildConfig` classes. No further hypothesis work required; see Root Cause Analysis above.

### 2. Kotlin Source Set Configuration — ❌ Ruled Out
Generated sources do exist (e.g., `mobile/android/app/build/generated/source/buildConfig/debug/com/photoeditor/BuildConfig.java`), so the source sets are healthy. The compiler fails only because it is looking for `com.photoeditor.app.*`, which does not get generated under the current namespace.

### 3. Expo Prebuild State Corruption — ⚠️ Deferred
While the prebuild folder is stale, regeneration is a *remediation mechanism* rather than the underlying cause. Only attempt `npx expo prebuild --clean` if manual namespace edits are undesirable or drift resurfaces.

### 4. Build Order Dependencies — ❌ Ruled Out
Gradle already runs `:app:generateDebugBuildConfig` and `:app:processDebugResources` before `:app:compileDebugKotlin`. Task order is correct; the Kotlin compilation simply cannot resolve classes emitted under the legacy namespace.

## Proposed Solutions (with Confidence Scores)

1. **Align Gradle namespace/applicationId with Expo config** — *Confidence: 0.92 (High)*
   - Update `mobile/android/app/build.gradle` so both `namespace` and `defaultConfig.applicationId` equal `com.photoeditor.app`.
   - Run `cd mobile/android && ./gradlew clean :app:generateDebugBuildConfig :app:compileDebugKotlin` (or `pnpm exec expo run:android`) to regenerate `BuildConfig`/`R` under the new namespace.
   - Validation: `find app/build/generated/source/buildConfig -path '*com/photoeditor/app*'` should now return files, and the Kotlin compile step should proceed.

2. **Regenerate the Android folder via Expo prebuild** — *Confidence: 0.73 (Medium)*
   - Commands: `cd mobile && mv android android.backup.$(date +%Y%m%d) && npx expo prebuild --platform android --clean`.
   - This recreates `android/app/build.gradle` directly from `app.json`, guaranteeing namespace alignment while preserving Expo-managed configuration.
   - Validation: verify Git diff only includes generated files plus namespace fix; rerun `pnpm exec expo run:android`.

3. **Temporary fallback: change Kotlin packages back to `com.photoeditor`** — *Confidence: 0.38 (Low)*
   - Adjust `package` declarations and folder paths under `mobile/android/app/src/main/java` to `com.photoeditor`.
   - This unblocks builds without touching Gradle config but diverges from the `app.json` identifiers and would need to be repeated for iOS (hence low confidence and only recommended as an emergency unblock).

## Gradle Build Timeline

Build progressed through 612 actionable tasks before failing:
1. ✓ Plugin configuration
2. ✓ Resource generation and packaging (all modules)
3. ✓ Manifest processing
4. ✓ R file generation (all modules)
5. ✓ BuildConfig generation (marked UP-TO-DATE)
6. ✓ Dependency module Kotlin compilation (expo-*, react-native-*)
7. ✗ **FAILED**: `:app:compileDebugKotlin`

The failure occurs specifically when compiling the main app module, while all dependency modules compiled successfully.

## Diagnostic Commands for Further Investigation

### 1. Check Generated Sources
```bash
# Verify BuildConfig exists
find mobile/android/app/build -name "BuildConfig.java" -o -name "BuildConfig.kt"

# Verify R class exists
find mobile/android/app/build -name "R.java" -o -name "R.kt"

# Check their contents (current location is com/photoeditor because of the namespace drift)
cat mobile/android/app/build/generated/source/buildConfig/debug/com/photoeditor/BuildConfig.java
```

### 2. Verify Namespace Configuration
```bash
# Check app build.gradle for namespace declaration
grep -A 5 "namespace" mobile/android/app/build.gradle

# Check AndroidManifest.xml for package declaration
grep "package=" mobile/android/app/src/main/AndroidManifest.xml
```

### 3. Clean Build Test
```bash
cd mobile/android
./gradlew clean
./gradlew :app:generateDebugBuildConfig --rerun-tasks
./gradlew :app:processDebugResources --rerun-tasks
./gradlew :app:compileDebugKotlin --stacktrace --info
```

### 4. Expo Prebuild Regeneration
```bash
cd mobile
mv android android.backup.$(date +%Y%m%d)
npx expo prebuild --platform android
pnpm exec expo run:android
```

## Next Steps (Priority Order)

1. Update `mobile/android/app/build.gradle` so `namespace` and `applicationId` are both `com.photoeditor.app`, then commit the change with a linked task.
2. Run `cd mobile/android && ./gradlew clean :app:compileDebugKotlin --stacktrace` (or `pnpm exec expo run:android`) to confirm the compiler now resolves `BuildConfig`/`R`.
3. If Gradle files show widespread drift, regenerate the entire `android/` folder via `npx expo prebuild --platform android --clean`, then re-run the build.
4. Capture the successful build logs, update this report + the corresponding `tasks/*.task.yaml`, and close the incident.

## Related Files

- `/home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainActivity.kt`
- `/home/jeffreymoya/dev/photoeditor/mobile/android/app/src/main/java/com/photoeditor/app/MainApplication.kt`
- `/home/jeffreymoya/dev/photoeditor/mobile/android/app/build.gradle`
- `/home/jeffreymoya/dev/photoeditor/mobile/android/gradle.properties`
- `/home/jeffreymoya/dev/photoeditor/mobile/android/build.gradle`

## Build Logs

- Full build log: `/tmp/gradle-build-full.log`
- Build attempt 3 log: `/tmp/gradle-build-third.log`
- Emulator launch log: `/tmp/emulator-wiped.log`
- Successful KVM boot log: `/tmp/emulator-kvm.log`

## Environment Changes Made (2025-11-07)

### Configuration Files Modified
1. `mobile/android/gradle.properties` - Added TLS protocol specification
2. `mobile/android/build.gradle` - Added expo-camera maven repository
3. `Makefile` - Added `mobile-android-emulator` target with KVM/GPU flags

### System State Changes
1. Cleared Gradle caches (`~/.gradle/caches/modules-2/`, `~/.gradle/caches/8.8/`)
2. Wiped emulator data (Pixel_API_34 AVD)
3. Installed NDK 26.1.10909125 (auto-installed by Gradle)

## Status

**Emulator**: ✅ Operational - Boots successfully, displays UI, KVM accelerated
**Gradle Dependencies**: ✅ Resolved - TLS issue fixed, all dependencies download successfully
**Kotlin Compilation**: ❌ **BLOCKED** - Unresolved references to R and BuildConfig in app module

The build pipeline is healthy through dependency compilation but fails when compiling the main application module due to missing generated class references.
