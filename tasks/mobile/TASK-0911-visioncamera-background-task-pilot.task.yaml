# Task: Pilot VisionCamera + expo-background-task for uploads

schema_version: "1.1"
id: TASK-0911
title: "Pilot VisionCamera + expo-background-task for uploads"
status: blocked
blocked_reason: "Broken down into subtasks for manageable implementation. Task exceeds complexity thresholds: 12+ deliverables across multiple feature domains (camera, upload, utils, config), 8 plan steps with substantial research phases, and multiple experimental integrations (VisionCamera Skia, expo-background-task) with known issues (memory leaks, platform scheduling limits)."
priority: P2
area: mobile
unblocker: false
order:
blocked_by: [TASK-0911B, TASK-0911C, TASK-0911D, TASK-0911E, TASK-0911F]
depends_on: [TASK-0906, TASK-0907]
agent_completion_state: {}

clarifications:
  outstanding: []
  resolved: true
  evidence_path: "docs/evidence/tasks/TASK-0911-clarifications.md"

description: >-
  Pilot VisionCamera with Skia frame processors for GPU-accelerated camera overlays
  (bounding
  boxes, live filters, AI editing previews) and migrate polling/notification upload
  jobs to
  expo-background-task (WorkManager on Android, BGTaskScheduler on iOS). VisionCamera's
  Skia
  frame processors enable on-device ML and live previews without leaving the Expo
  ecosystem,
  while expo-background-task (new in Expo SDK 53) replaces deprecated expo-background-fetch
  with reliable retries for uploads and notification hydration. Frame processors require
  Reanimated worklets and can starve the UI thread if 16ms budget is exceeded; guardrails
  (feature flags, diagnostics) are needed for lower-end devices. Measure end-to-end
  upload
  latency and success rate vs. current baseline.

outcome: >-
  VisionCamera Skia frame processors successfully integrated for camera overlays.
  expo-background-task
  configured for upload pipeline with WorkManager/BGTaskScheduler scheduling. Upload
  success rate
  meets or exceeds current baseline with fewer manual retries. Frame processor memory
  leaks profiled
  and mitigated. Feature flags implemented for lower-end devices.

scope:
  in:
  - Installing VisionCamera and Skia dependencies in mobile/package.json
  - Implementing Skia frame processors for camera overlays (bounding boxes, 
    filters, or previews)
  - Installing and configuring expo-background-task for upload pipeline
  - Migrating upload/notification jobs from current polling/push model to 
    background tasks
  - Profiling VisionCamera Skia memory leaks (issue   #3517) and applying mitigations
  - Implementing feature flags and diagnostics for lower-end devices (16ms frame
    budget guardrails)
  - Measuring upload success rate and end-to-end latency vs. baseline
  - Documenting platform entitlements and scheduling limits
  out:
  - Full camera replacement (pilot Skia overlays only)
  - Migrating all background jobs (upload pilot only)
  - Styling system changes (deferred to TASK-0909)
  - List virtualization changes (deferred to TASK-0910)

context:
  affected_packages: [mobile]
  standards_tier: mobile
  related_docs:
  - standards/global.md
  - standards/AGENTS.md
  - standards/frontend-tier.md
  - standards/typescript.md
  - standards/testing-standards.md
  - docs/proposals/mobile-stack-modernization.md
  - VisionCamera Skia frame processor guide
  - expo-background-task documentation
  repo_paths:
  - mobile/package.json
  - mobile/src/features/camera/
  - mobile/src/features/upload/
  - mobile/app.json
  - docs/mobile/
  dependencies:
  - react-native-vision-camera
  - react-native-skia
  - expo-background-task
  - react-native-reanimated

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
  - name: pnpm
    version: "8.x"
  data: []

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
  - Follow VisionCamera and Skia frame processor best practices
  - Implement feature flags for lower-end devices (16ms frame budget guardrails)
  - Profile memory usage for Skia workflows (issue   #3517)
  - Configure expo-background-task per platform entitlements (WorkManager, 
    BGTaskScheduler)
  - Measure upload metrics vs. baseline
  prohibited:
  - Do not replace entire camera implementation (pilot overlays only)
  - Do not migrate all background jobs (upload pipeline only)

plan:
- id: 1
  title: Review VisionCamera/expo-background-task docs and clarify pilot scope
  details: >-
    Read VisionCamera Skia frame processor guide and expo-background-task documentation.
    Clarify frame processor use case, memory leak profiling, background task scheduling,
    feature flags, and success metrics. Document findings in clarifications file.
    Reference
    standards/frontend-tier.md for camera/upload feature organization.
  actor: agent
  inputs:
  - docs/proposals/mobile-stack-modernization.md
  - VisionCamera Skia frame processor guide
  - expo-background-task documentation
  - VisionCamera memory leak issue     #3517
  outputs:
  - docs/evidence/tasks/TASK-0911-clarifications.md
  definition_of_done:
  - Clarifications file documents frame processor use case, profiling 
    procedures, scheduling strategy, feature flags, success metrics
  - Open questions resolved
  estimate: M
  expected_files_touched:
  - docs/evidence/tasks/TASK-0911-clarifications.md
- id: 2
  title: Install VisionCamera, Skia, and expo-background-task dependencies
  details: >-
    Add react-native-vision-camera, react-native-skia, expo-background-task, and
    react-native-reanimated to mobile/package.json. Configure platform permissions
    and
    entitlements in app.json. Run pnpm install. Verify standards/typescript.md strict
    config remains satisfied.
  actor: agent
  inputs:
  - mobile/package.json
  - mobile/app.json
  - VisionCamera installation guide
  - expo-background-task setup docs
  outputs:
  - mobile/package.json (VisionCamera, Skia, background-task dependencies)
  - mobile/app.json (camera permissions, background task entitlements)
  - pnpm-lock.yaml
  definition_of_done:
  - VisionCamera, Skia, and background-task dependencies installed
  - Platform permissions and entitlements configured
  - pnpm install completes successfully
  estimate: M
  expected_files_touched:
  - mobile/package.json
  - mobile/app.json
  - pnpm-lock.yaml
- id: 3
  title: Implement Skia frame processors for camera overlays
  details: >-
    Create Skia frame processors for camera overlays (bounding boxes, live filters,
    or AI
    previews). Implement Reanimated worklets per VisionCamera docs. Follow standards/frontend-tier.md
    component organization. Test on iOS simulator and Android emulator.
  actor: agent
  inputs:
  - mobile/src/features/camera/ (existing camera implementation)
  - VisionCamera Skia frame processor examples
  outputs:
  - mobile/src/features/camera/frameProcessors.ts
  - mobile/src/features/camera/CameraWithOverlay.tsx
  definition_of_done:
  - Skia frame processors implemented for camera overlays
  - Reanimated worklets configured
  - Overlays render correctly on iOS and Android
  estimate: L
  expected_files_touched:
  - mobile/src/features/camera/frameProcessors.ts
  - mobile/src/features/camera/CameraWithOverlay.tsx
- id: 4
  title: Configure expo-background-task for upload pipeline
  details: >-
    Set up expo-background-task scheduling (WorkManager on Android, BGTaskScheduler
    on iOS)
    for upload pipeline. Migrate current polling/push upload jobs to background task
    workers.
    Integrate with notification/queue standards per standards/frontend-tier.md.
  actor: agent
  inputs:
  - mobile/src/features/upload/ (existing upload logic)
  - expo-background-task scheduling docs
  outputs:
  - mobile/src/features/upload/backgroundTasks.ts
  - mobile/app.json (background task configuration)
  definition_of_done:
  - expo-background-task configured for uploads
  - Upload jobs migrated to background task workers
  - WorkManager/BGTaskScheduler scheduling verified
  estimate: L
  expected_files_touched:
  - mobile/src/features/upload/backgroundTasks.ts
  - mobile/app.json
- id: 5
  title: Profile VisionCamera Skia memory leaks and implement mitigations
  details: >-
    Profile memory usage for Skia frame processors (issue #3517). Identify memory
    leaks
    or performance bottlenecks. Apply mitigations (frame processor cleanup, memory
    limits).
    Document profiling procedures and findings. Reference standards/frontend-tier.md
    for
    performance thresholds if applicable.
  actor: agent
  inputs:
  - mobile/src/features/camera/ (Skia implementation)
  - VisionCamera memory leak issue     #3517
  outputs:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  definition_of_done:
  - Memory profiling completed for Skia workflows
  - Leaks identified and mitigations applied
  - Profiling procedures documented
  estimate: M
  expected_files_touched:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  - mobile/src/features/camera/frameProcessors.ts (if mitigations needed)
- id: 6
  title: Implement feature flags and frame budget guardrails
  details: >-
    Add feature flags for lower-end devices to disable frame processors if 16ms budget
    is
    exceeded. Implement diagnostics to monitor frame processing times. Test on lower-end
    emulators. Reference standards/frontend-tier.md for feature flag patterns.
  actor: agent
  inputs:
  - mobile/src/features/camera/ (Skia implementation)
  outputs:
  - mobile/src/utils/featureFlags.ts (frame processor flags)
  - mobile/src/features/camera/frameBudgetMonitor.ts
  definition_of_done:
  - Feature flags implemented for lower-end devices
  - Frame budget diagnostics in place
  - Tested on lower-end emulators
  estimate: M
  expected_files_touched:
  - mobile/src/utils/featureFlags.ts
  - mobile/src/features/camera/frameBudgetMonitor.ts
- id: 7
  title: Measure upload success rate and latency vs. baseline
  details: >-
    Capture upload success rate and end-to-end latency metrics before/after expo-background-task
    migration. Compare against current baseline. Verify fewer manual retries needed.
    Document
    metrics and findings.
  actor: agent
  inputs:
  - mobile/src/features/upload/ (background task implementation)
  outputs:
  - docs/evidence/tasks/TASK-0911-upload-metrics.md
  definition_of_done:
  - Upload success rate and latency metrics captured before/after migration
  - Metrics meet or exceed current baseline
  - Fewer manual retries documented
  estimate: M
  expected_files_touched:
  - docs/evidence/tasks/TASK-0911-upload-metrics.md
- id: 8
  title: Document camera/background task pilot outcomes
  details: >-
    Document VisionCamera Skia and expo-background-task pilot outcomes, including
    overlay
    implementation, memory profiling, feature flags, upload metrics, and platform
    entitlements.
    Ensure standards/global.md evidence bundle requirements are met.
  actor: agent
  inputs:
  - docs/evidence/tasks/TASK-0911-clarifications.md
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  - docs/evidence/tasks/TASK-0911-upload-metrics.md
  outputs:
  - docs/mobile/visioncamera-background-task-pilot.md
  definition_of_done:
  - Pilot outcomes documented in docs/mobile/
  - Memory profiling, feature flags, upload metrics included
  estimate: S
  expected_files_touched:
  - docs/mobile/visioncamera-background-task-pilot.md

validation:
  pipeline:
  - command: pnpm turbo run lint:fix --filter=photoeditor-mobile
    description: Auto-fix linting issues in mobile package
  - command: pnpm turbo run qa:static --filter=photoeditor-mobile
    description: Run static analysis (typecheck + lint) on mobile
  - command: pnpm turbo run test --filter=photoeditor-mobile
    description: Run unit tests for mobile package
  - command: pnpm turbo run test:coverage --filter=photoeditor-mobile
    description: Run tests with coverage reporting to verify thresholds (≥70% 
      lines, ≥60% branches per standards/testing-standards.md)
  manual_checks:
  - Verify VisionCamera Skia overlays render correctly on iOS simulator
  - Verify VisionCamera Skia overlays render correctly on Android emulator
  - Test expo-background-task scheduling for upload pipeline on both platforms
  - Profile memory usage for Skia frame processors (confirm no critical leaks)
  - Verify feature flags disable frame processors on lower-end devices
  - Measure upload success rate and latency vs. baseline

acceptance_criteria:
  must:
  - VisionCamera, Skia, and expo-background-task dependencies installed and 
    configured
  - Skia frame processors implemented for camera overlays
  - expo-background-task configured for upload pipeline
  - Upload jobs migrated to background task workers
  - Memory profiling completed with mitigations applied
  - Feature flags and frame budget guardrails implemented
  - Upload success rate meets or exceeds current baseline
  - pnpm turbo run qa:static --filter=photoeditor-mobile passes
  - Platform entitlements and scheduling limits documented
  quality_gates:
  - All tests pass with VisionCamera and background tasks enabled
  - No critical memory leaks in Skia frame processors
  - Frame budget guardrails prevent UI thread starvation on lower-end devices
  - Upload metrics validate reliability improvement

artifacts:
- path: docs/evidence/tasks/TASK-0911-clarifications.md
  description: Frame processor use case, profiling procedures, scheduling 
    strategy, success metrics
- path: docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  description: VisionCamera Skia memory profiling and mitigations
- path: docs/evidence/tasks/TASK-0911-upload-metrics.md
  description: Upload success rate and latency metrics before/after migration
- path: docs/mobile/visioncamera-background-task-pilot.md
  description: Pilot outcomes, overlay implementation, feature flags, platform 
    entitlements

deliverables:
- mobile/package.json (VisionCamera, Skia, background-task dependencies)
- mobile/app.json (camera permissions, background task entitlements)
- mobile/src/features/camera/frameProcessors.ts
- mobile/src/features/camera/CameraWithOverlay.tsx
- mobile/src/features/upload/backgroundTasks.ts
- mobile/src/utils/featureFlags.ts
- mobile/src/features/camera/frameBudgetMonitor.ts
- pnpm-lock.yaml
- docs/evidence/tasks/TASK-0911-clarifications.md
- docs/evidence/tasks/TASK-0911-memory-profiling-results.md
- docs/evidence/tasks/TASK-0911-upload-metrics.md
- docs/mobile/visioncamera-background-task-pilot.md

risks:
- description: VisionCamera Skia workflows may leak memory in certain scenarios 
    (issue                                                                               #3517)
  mitigation: Profile thoroughly, apply upstream fixes if available, implement 
    cleanup guards
- description: Frame processors may starve UI thread if 16ms budget is exceeded
  mitigation: Implement feature flags, diagnostics, disable on lower-end devices
- description: Background tasks may not run reliably due to platform scheduling 
    limits
  mitigation: Test scheduling on both platforms, document entitlement 
    requirements, fall back to polling if needed
- description: Upload success rate may not improve if network reliability is the
    bottleneck
  mitigation: Measure baseline carefully, focus on retry reliability rather than
    raw success rate
