# Task: Configure expo-background-task for upload pipeline

schema_version: "1.1"
id: TASK-0911C
title: "Configure expo-background-task for upload pipeline"
status: todo
blocked_reason: null
priority: P2
area: mobile
unblocker: false
order: 3
blocked_by: []
depends_on: [TASK-0906]
agent_completion_state: {}

clarifications:
  outstanding: []
  resolved: true
  evidence_path: "docs/evidence/tasks/TASK-0911-clarifications.md"

description: >-
  Migrate upload pipeline from current polling/push model to expo-background-task
  (WorkManager on Android, BGTaskScheduler on iOS). expo-background-task provides
  reliable background execution with retries for uploads and notification hydration.
  Configure immediate dispatch with exponential backoff retry strategy per clarifications.
  Integrate with existing upload services and notification queue per standards/frontend-tier.md.

outcome: >-
  expo-background-task configured for upload pipeline with WorkManager/BGTaskScheduler
  scheduling. Upload jobs migrated to background task workers. Immediate dispatch with
  exponential backoff retry implemented. Integration with existing upload services complete.

scope:
  in:
  - Configuring expo-background-task for upload pipeline
  - Migrating upload jobs to background task workers
  - Implementing immediate dispatch with exponential backoff retry
  - Integrating with existing upload services and notification queue
  out:
  - Upload metrics measurement (deferred to TASK-0911F)
  - Feature flags or performance monitoring (deferred to TASK-0911E)
  - Migrating non-upload background jobs (upload pilot only per scope)

context:
  affected_packages: [mobile]
  standards_tier: mobile
  related_docs:
  - standards/global.md
  - standards/AGENTS.md
  - standards/frontend-tier.md
  - standards/typescript.md
  - standards/testing-standards.md
  - docs/proposals/mobile-stack-modernization.md
  repo_paths:
  - mobile/src/features/upload/backgroundTasks.ts
  - mobile/src/features/upload/services/
  - mobile/app.json
  dependencies:
  - expo-background-task

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
  - name: pnpm
    version: "8.x"
  data: []

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
  - Follow expo-background-task scheduling guide for WorkManager/BGTaskScheduler
  - Implement immediate dispatch with exponential backoff retry per clarifications
  - Integrate with existing upload services per standards/frontend-tier.md
  - Follow standards/typescript.md for error handling with neverthrow Result
  prohibited:
  - Do not migrate non-upload background jobs (upload pilot only)
  - Do not implement upload metrics measurement (deferred to TASK-0911F)

plan:
- id: 1
  title: Create background task module for uploads
  details: >-
    Create mobile/src/features/upload/backgroundTasks.ts module. Define background
    task registration and worker functions per expo-background-task API. Follow
    standards/frontend-tier.md#services--integration-layer for service integration
    patterns.
  actor: agent
  inputs:
  - expo-background-task scheduling documentation
  - standards/frontend-tier.md
  outputs:
  - mobile/src/features/upload/backgroundTasks.ts (module structure)
  definition_of_done:
  - Background task module created with registration and worker exports
  - Module follows standards/frontend-tier.md service integration patterns
  estimate: S
  expected_files_touched:
  - mobile/src/features/upload/backgroundTasks.ts
- id: 2
  title: Implement upload background task worker
  details: >-
    Implement background task worker function that executes upload operations.
    Integrate with existing upload services in mobile/src/features/upload/services/.
    Use neverthrow Result for error handling per standards/typescript.md#analyzability.
    Follow standards/frontend-tier.md#purity--immutability-in-services for service
    isolation.
  actor: agent
  inputs:
  - mobile/src/features/upload/services/
  - expo-background-task worker API
  - standards/typescript.md
  - standards/frontend-tier.md
  outputs:
  - mobile/src/features/upload/backgroundTasks.ts (worker implementation)
  definition_of_done:
  - Worker function executes upload operations via existing services
  - Error handling uses neverthrow Result per standards/typescript.md
  - Service calls follow standards/frontend-tier.md purity patterns
  estimate: M
  expected_files_touched:
  - mobile/src/features/upload/backgroundTasks.ts
- id: 3
  title: Implement exponential backoff retry strategy
  details: >-
    Implement exponential backoff retry strategy for upload failures (1s, 2s, 4s,
    8s, max 60s per clarifications). Use expo-background-task retry configuration
    or p-retry library per standards/frontend-tier.md#services--integration-layer.
    Log retry attempts with correlation IDs per standards/typescript.md#analyzability.
  actor: agent
  inputs:
  - expo-background-task retry API
  - standards/frontend-tier.md
  - standards/typescript.md
  outputs:
  - mobile/src/features/upload/backgroundTasks.ts (retry strategy)
  definition_of_done:
  - Exponential backoff retry implemented (1s, 2s, 4s, 8s, max 60s)
  - Retry attempts logged with correlation IDs
  estimate: M
  expected_files_touched:
  - mobile/src/features/upload/backgroundTasks.ts
- id: 4
  title: Configure background task scheduling in app.json
  details: >-
    Configure expo-background-task scheduling parameters in mobile/app.json. Set
    WorkManager constraints for Android and BGTaskScheduler parameters for iOS per
    expo-background-task documentation. Document platform-specific scheduling limits.
  actor: agent
  inputs:
  - mobile/app.json
  - expo-background-task configuration guide
  outputs:
  - mobile/app.json (background task scheduling configuration)
  definition_of_done:
  - WorkManager constraints configured for Android
  - BGTaskScheduler parameters configured for iOS
  - Platform scheduling limits documented in comments
  estimate: S
  expected_files_touched:
  - mobile/app.json
- id: 5
  title: Integrate background task with upload service API
  details: >-
    Update existing upload service callers to dispatch background tasks immediately
    after photo capture per clarifications. Maintain existing upload service APIs
    to minimize breaking changes. Follow standards/frontend-tier.md#ports--adapters
    for service integration.
  actor: agent
  inputs:
  - mobile/src/features/upload/services/
  - mobile/src/features/upload/backgroundTasks.ts
  - standards/frontend-tier.md
  outputs:
  - Updated upload service callers to dispatch background tasks
  definition_of_done:
  - Upload service callers dispatch background tasks immediately after capture
  - Existing upload service APIs maintained for compatibility
  - Integration follows standards/frontend-tier.md ports & adapters pattern
  estimate: M
  expected_files_touched:
  - mobile/src/features/upload/services/
  - mobile/src/screens/CameraScreen.tsx (or caller)
- id: 6
  title: Add tests for background task workers
  details: >-
    Create mobile/src/features/upload/__tests__/backgroundTasks.test.ts with tests
    for worker functions and retry strategy. Mock expo-background-task APIs and
    upload services. Follow standards/testing-standards.md coverage expectations
    (≥70% lines, ≥60% branches).
  actor: agent
  inputs:
  - mobile/src/features/upload/backgroundTasks.ts
  - standards/testing-standards.md
  outputs:
  - mobile/src/features/upload/__tests__/backgroundTasks.test.ts
  definition_of_done:
  - Tests cover worker execution and retry strategy
  - Tests meet standards/testing-standards.md coverage thresholds
  estimate: M
  expected_files_touched:
  - mobile/src/features/upload/__tests__/backgroundTasks.test.ts

validation:
  pipeline:
  - command: pnpm turbo run lint:fix --filter=photoeditor-mobile
    description: Auto-fix linting issues in mobile package
  - command: pnpm turbo run qa:static --filter=photoeditor-mobile
    description: Run static analysis (typecheck + lint) on mobile
  - command: pnpm turbo run test --filter=photoeditor-mobile
    description: Run unit tests for mobile package
  - command: pnpm turbo run test:coverage --filter=photoeditor-mobile
    description: Run tests with coverage reporting to verify thresholds (≥70% lines, ≥60% branches per standards/testing-standards.md)
  manual_checks:
  - Test expo-background-task scheduling for upload pipeline on iOS simulator
  - Test expo-background-task scheduling for upload pipeline on Android emulator
  - Verify exponential backoff retry strategy executes correctly
  - Verify WorkManager scheduling on Android
  - Verify BGTaskScheduler scheduling on iOS

acceptance_criteria:
  must:
  - expo-background-task configured for upload pipeline
  - Upload jobs migrated to background task workers
  - Immediate dispatch with exponential backoff retry implemented (1s, 2s, 4s, 8s, max 60s)
  - Integration with existing upload services complete
  - Tests meet standards/testing-standards.md coverage thresholds (≥70% lines, ≥60% branches)
  - pnpm turbo run qa:static --filter=photoeditor-mobile passes
  - WorkManager/BGTaskScheduler scheduling verified on both platforms
  quality_gates:
  - Error handling uses neverthrow Result per standards/typescript.md
  - Service integration follows standards/frontend-tier.md ports & adapters pattern
  - Retry attempts logged with correlation IDs

artifacts:
- path: mobile/src/features/upload/backgroundTasks.ts
  description: Background task workers and retry strategy for uploads
- path: mobile/app.json
  description: Background task scheduling configuration (WorkManager/BGTaskScheduler)
- path: mobile/src/features/upload/__tests__/backgroundTasks.test.ts
  description: Tests for background task workers

deliverables:
- mobile/src/features/upload/backgroundTasks.ts
- mobile/app.json (background task configuration)
- mobile/src/features/upload/__tests__/backgroundTasks.test.ts
- Updated upload service callers

risks:
- description: Background tasks may not run reliably due to platform scheduling limits
  mitigation: Test scheduling on both platforms, document entitlement requirements, prepare fallback to polling if needed
- description: Exponential backoff may delay uploads too long on network failures
  mitigation: Cap max retry delay at 60s per clarifications, monitor upload latency in TASK-0911F
