# Task: Profile VisionCamera Skia memory leaks and implement mitigations

schema_version: "1.1"
id: TASK-0911D
title: "Validate VisionCamera Skia memory usage (Android pilot, basic validation only)"
status: blocked
blocked_reason: "Blocked by TASK-0911G (Skia canvas integration for Android). Formal profiling deferred per user preference and Android-first pilot strategy (ADR-0011). See docs/evidence/tasks/TASK-0911D-blocking-analysis.md"
priority: P2
area: mobile
unblocker: false
order: 4
blocked_by: [TASK-0911G]
depends_on: []
agent_completion_state: {}

clarifications:
  outstanding: []
  resolved: true
  evidence_path: "docs/evidence/tasks/TASK-0911-clarifications.md"

description: >-
  Validate memory usage for VisionCamera Skia frame processors on Android pilot using
  basic testing (no formal profiling per user preference). TASK-0911G provides canvas
  integration and cleanup hooks. This task validates that no obvious memory issues
  exist during 2-3 minute camera sessions using React DevTools component profiler.
  Formal profiling with Xcode Instruments / Android Studio Profiler deferred per
  Android-first pilot strategy (ADR-0011, ADR-0012). iOS testing explicitly deferred
  to post-pilot phase.

outcome: >-
  Basic memory validation completed for Android pilot. No obvious memory growth
  observed during 2-3 minute camera sessions. React DevTools component profiler
  shows acceptable memory patterns. Cleanup hooks (from TASK-0911G) verified to
  release resources on component unmount. Formal profiling deferral documented with
  rationale. Android pilot unblocked for feature flag implementation (TASK-0911E).

scope:
  in:
  - Basic memory validation on Android emulator (2-3 min camera sessions)
  - React DevTools component profiler checks for memory patterns
  - Visual inspection for obvious memory growth or leaks
  - Verify cleanup hooks (from TASK-0911G) properly release resources on unmount
  - Document Android validation results and formal profiling deferral rationale
  - Reference ADR-0011 (Android-first pilot) and ADR-0012 (Skia integration)
  out:
  - Formal profiling with Xcode Instruments (deferred to iOS pilot phase)
  - Formal profiling with Android Studio Profiler (deferred per user preference)
  - Baseline vs. Skia memory comparison (not required for pilot)
  - Extended camera sessions >5 min (2-3 min sufficient for pilot)
  - iOS testing (deferred per ADR-0011 Android-first strategy)
  - Feature flags or performance guardrails (deferred to TASK-0911E)
  - Upload metrics measurement (deferred to TASK-0911F)

context:
  affected_packages: [mobile]
  standards_tier: mobile
  related_docs:
  - standards/global.md
  - standards/AGENTS.md
  - standards/frontend-tier.md
  - standards/typescript.md
  - standards/testing-standards.md
  - adr/0011-android-first-pilot-strategy.md
  - adr/0012-visioncamera-skia-integration.md
  - docs/mobile/visioncamera-background-task-pilot.md
  repo_paths:
  - mobile/src/features/camera/frameProcessors.ts
  - mobile/src/features/camera/CameraWithOverlay.tsx
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  dependencies:
  - react-native-vision-camera
  - react-native-skia

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
  - name: pnpm
    version: "8.x"
  data: []

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
  - Document Android validation results with React DevTools evidence
  - Reference ADR-0011 and ADR-0012 for platform strategy and deferral rationale
  - Note formal profiling deferral per user preference (pilot tolerance)
  prohibited:
  - Do not perform formal Xcode Instruments profiling (deferred to iOS pilot)
  - Do not perform formal Android Studio Profiler sessions (deferred per user preference)
  - Do not implement feature flags or performance monitoring (deferred to TASK-0911E)

plan:
- id: 1
  title: Review Android canvas integration and cleanup hooks
  details: >-
    Review TASK-0911G deliverables: completed canvas wiring at CameraWithOverlay.tsx:128
    and cleanup hooks implementation. Understand the cleanup patterns applied and
    what resources are being disposed. Reference ADR-0011 (Android-first pilot)
    and ADR-0012 (Skia integration) for context. Prepare for basic validation testing
    on Android emulator per standards/frontend-tier.md#component-architecture.
  actor: agent
  inputs:
  - mobile/src/features/camera/CameraWithOverlay.tsx (from TASK-0911G)
  - mobile/src/features/camera/frameProcessors.ts
  - adr/0011-android-first-pilot-strategy.md
  - adr/0012-visioncamera-skia-integration.md
  outputs:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md (review notes)
  definition_of_done:
  - Canvas integration and cleanup hooks understood
  - Platform strategy (Android-only pilot) confirmed
  - Review notes documented in evidence file
  estimate: S
  expected_files_touched:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
- id: 2
  title: Perform basic memory validation on Android emulator
  details: >-
    Run camera screen on Android emulator with Skia overlays enabled. Execute 2-3
    minute camera sessions with various overlay combinations (bounding boxes, filters,
    AI graphics). Use React DevTools component profiler to monitor memory patterns.
    Visually inspect for obvious memory growth or performance degradation. Test
    component unmount to verify cleanup hooks properly release resources. Document
    findings per standards/testing-standards.md#validation-evidence.
  actor: agent
  inputs:
  - mobile/src/features/camera/CameraWithOverlay.tsx (with overlays)
  - Android emulator (API 29+)
  - React DevTools component profiler
  outputs:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md (Android validation section)
  definition_of_done:
  - 2-3 min camera sessions completed with overlays enabled
  - React DevTools profiler shows acceptable memory patterns
  - No obvious memory growth observed visually
  - Cleanup hooks verified to release resources on unmount
  - Validation results documented per standards/testing-standards.md#validation-evidence
  estimate: M
  expected_files_touched:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
- id: 3
  title: Document formal profiling deferral and unblock downstream tasks
  details: >-
    Update evidence file with formal profiling deferral rationale: user preference
    for pilot, Android-first strategy (ADR-0011), risk tolerance for basic validation.
    Document that iOS testing is explicitly deferred to post-pilot phase. Note that
    formal profiling (Xcode Instruments / Android Studio Profiler) can be revisited
    if specific issues arise. Update pilot document status to reflect Android
    validation complete. Confirm TASK-0911E is unblocked for feature flag work.
  actor: agent
  inputs:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md (validation results)
  - adr/0011-android-first-pilot-strategy.md
  - adr/0012-visioncamera-skia-integration.md
  - docs/mobile/visioncamera-background-task-pilot.md
  outputs:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md (deferral rationale)
  - docs/mobile/visioncamera-background-task-pilot.md (updated status)
  definition_of_done:
  - Formal profiling deferral rationale documented with ADR references
  - iOS deferral explicitly noted in evidence file
  - Pilot document updated to reflect Android validation complete
  - TASK-0911E confirmed unblocked
  estimate: S
  expected_files_touched:
  - docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  - docs/mobile/visioncamera-background-task-pilot.md

validation:
  pipeline:
  - command: pnpm turbo run lint:fix --filter=photoeditor-mobile
    description: Auto-fix linting issues in mobile package
  - command: pnpm turbo run qa:static --filter=photoeditor-mobile
    description: Run static analysis (typecheck + lint) on mobile
  - command: pnpm turbo run test --filter=photoeditor-mobile
    description: Run unit tests for mobile package
  manual_checks:
  - Run camera screen on Android emulator with Skia overlays enabled
  - Execute 2-3 min camera sessions with various overlay combinations
  - Monitor memory patterns using React DevTools component profiler
  - Visually inspect for obvious memory growth or performance issues
  - Test component unmount and verify cleanup hooks release resources
  - Document validation results and formal profiling deferral in evidence file

acceptance_criteria:
  must:
  - Basic memory validation completed on Android emulator (2-3 min sessions)
  - React DevTools component profiler shows acceptable memory patterns
  - No obvious memory growth observed during camera sessions
  - Cleanup hooks (from TASK-0911G) verified to release resources on unmount
  - Formal profiling deferral documented with rationale (user preference, ADR-0011)
  - iOS testing deferral explicitly noted (Android-first pilot per ADR-0011)
  - Evidence file updated with Android validation results
  - pnpm turbo run qa:static --filter=photoeditor-mobile passes
  - TASK-0911E unblocked for feature flag implementation
  quality_gates:
  - No obvious memory leaks observed in basic validation
  - Component unmount properly disposes Skia resources
  - Documentation references ADR-0011 and ADR-0012 correctly

artifacts:
- path: docs/evidence/tasks/TASK-0911-memory-profiling-results.md
  description: Android basic validation results and formal profiling deferral rationale

deliverables:
- docs/evidence/tasks/TASK-0911-memory-profiling-results.md (Android validation + deferral rationale)
- docs/mobile/visioncamera-background-task-pilot.md (updated status)

risks:
- description: Basic validation may miss subtle memory issues that formal profiling would catch
  mitigation: User preference for pilot risk tolerance; feature flags (TASK-0911E) allow quick disable; formal profiling can be added later if specific issues arise in pilot testing
- description: Android may have VisionCamera issue #3517 memory leak (status unknown for Android)
  mitigation: Basic validation catches obvious leaks; feature flag toggle provides quick disable; pilot scope limits exposure; can adopt iOS workaround if needed
- description: iOS memory leak (#3517) remains unaddressed until post-pilot phase
  mitigation: Android-first strategy (ADR-0011) defers iOS deliberately; separation architecture workaround documented in ADR-0012 for future iOS implementation
