schema_version: "1.0"
id: TASK-0815
title: "Automate traceparent live drill evidence"
status: completed
priority: P1
area: ops

description: >-
  Add a CI-friendly drill that parses Powertools log samples (from live-dev or fixtures) to
  prove W3C traceparent propagation and required structured log fields per cross-cutting
  standards. The script should emit a coverage summary for the evidence bundle and fail when
  correlation, trace, or request identifiers are missing.

outcome: >-
  Running `node scripts/ci/traceparent-drill.mjs` validates logs, writes
  `docs/evidence/trace-drill-report.json`, and exits non-zero if traceparent/correlation
  coverage falls below standards thresholds so PRs surface observability regressions.

scope:
  in:
    - scripts/ci/traceparent-drill.mjs
    - scripts/evidence-bundle (invoke drill during evidence collection)
    - docs/evidence/trace-drill-report.json
    - docs/evidence/logs/powertools-sample.json (baseline fixture)
  out:
    - Real AWS log ingestion (script consumes local fixture or exported logs)
    - Broader observability dashboards beyond trace propagation summary

context:
  standards_tier: ops
  issues: []
  related_docs:
    - standards/cross-cutting.md#observability--operations
    - standards/global.md#example-quality-gate
    - docs/evidence/trace-propagation-example.json
  repo_paths:
    - scripts/ci/traceparent-drill.mjs
    - scripts/evidence-bundle
    - docs/evidence/trace-drill-report.json
    - docs/evidence/logs/powertools-sample.json
  dependencies: []

environment:
  os: ubuntu-22.04
  runtimes:
    node: "20.x"
  tools:
    - name: pnpm
      version: "8.x"

constraints:
  approvals_required: false
  sandbox:
    filesystem: workspace-write
    network: enabled
  coding_guidelines:
    - Keep diffs minimal and focused
    - Respect repository conventions
  prohibited:
    - No secrets or tokens in code
    - No unrelated file changes

plan:
  - id: 1
    title: Confirm required observability fields
    details: Review standards and existing sample evidence to list mandatory log keys and thresholds.
    actor: agent
    inputs:
      - docs/evidence/logs/powertools-sample.json
      - standards/cross-cutting.md
    outputs: []
    definition_of_done:
      - Required keys and thresholds enumerated
    estimate: S
    expected_files_touched: []
  - id: 2
    title: Implement trace drill script
    details: Build scripts/ci/traceparent-drill.mjs to parse JSON or JSONL logs and compute coverage metrics.
    actor: agent
    inputs: []
    outputs:
      - scripts/ci/traceparent-drill.mjs
    definition_of_done:
      - Script parses sample and computes coverage
    estimate: M
    expected_files_touched:
      - scripts/ci/traceparent-drill.mjs
  - id: 3
    title: Integrate drill into evidence bundle
    details: Update scripts/evidence-bundle to run the drill and capture the resulting JSON artifact.
    actor: agent
    inputs: []
    outputs:
      - scripts/evidence-bundle
    definition_of_done:
      - Evidence bundle includes drill and artifact path
    estimate: S
    expected_files_touched:
      - scripts/evidence-bundle
  - id: 4
    title: Verify success and failure paths
    details: Run drill against valid samples and mutated data to confirm exit codes and artifact contents.
    actor: agent
    inputs: []
    outputs:
      - docs/evidence/trace-drill-report.json
    definition_of_done:
      - Report written; failure path produces non-zero exit code
    estimate: S
    expected_files_touched:
      - docs/evidence/trace-drill-report.json

acceptance_criteria:
  - Drill parses Powertools JSON or JSONL logs and enforces correlationId, traceId, requestId, function, env, and version fields.
  - Missing required fields or trace coverage below thresholds per `standards/cross-cutting.md` causes non-zero exit code with clear diagnostics.
  - Successful run saves docs/evidence/trace-drill-report.json summarizing coverage stats and thresholds.
  - Evidence bundle run includes the drill and captures the artifact for the release bundle.
  modularity:
    - "Handler and Service/Adapter LOC/complexity within budgets per standards/cross-cutting.md"
    - "No cross-layer imports (dependency-cruiser enforced)"
  testability:
    - "Coverage thresholds per standards/testing-standards.md"
    - "Contract tests pass for all routes"

validation:
  manual_checks:
    - Inspect docs/evidence/trace-drill-report.json to confirm coverage meets thresholds in `standards/cross-cutting.md` and includes required fields.
  artifacts:
    - docs/evidence/trace-drill-report.json

deliverables:
  - scripts/ci/traceparent-drill.mjs
  - scripts/evidence-bundle
  - docs/evidence/trace-drill-report.json

risks:
  - description: Log schemas may evolve, breaking the parser.
    mitigation: Keep required field list configurable and document fixture update workflow in task notes.
